/**
 * @name os2display screen-bundle
 * @version v1.0.0
 * @link https://github.com/os2display/screen-bundle
 */
if(Offline={off:function(){},on:function(){},check:function(){},state:"up"},$.ajaxSetup({cache:!0}),angular.module("ikApp",["ngAnimate","ngSanitize","angular.css.injector"]).config(["$sceDelegateProvider",function(e){"use strict";e.resourceUrlWhitelist(["self","**"])}]).config(["$animateProvider",function(e){"use strict";e.classNameFilter(/^(?:(?!ng-animate-disabled).)*$/)}]).config(["$provide",function(e){"use strict";e.decorator("$exceptionHandler",["$delegate","$injector",function(t,o){return function(e,n){t(e,n),o.get("logging").error(e,n)}}])}]),function(){var e=null,n=!1;function t(){e=null,document.body.style.cursor="url(/bundles/os2displayscreen/assets/images/trans.gif),none",n=!1}-1<navigator.userAgent.toLowerCase().indexOf("chrome")||document.addEventListener("mousemove",function(){e&&window.clearTimeout(e),n||(document.body.style.cursor="default",n=!0),e=window.setTimeout(t,5e3)})}(),angular.module("ikApp").filter("activeEvents",function(){"use strict";return function(e){if(!angular.isArray(e))return!1;for(var n=parseInt(Date.now()/1e3),t=[],o=0;o<e.length;o++){var i=e[o];i.from&&i.to&&i.to>=n?t.push(i):i.from&&i.from>=n&&t.push(i)}return t}}),function(){"use strict";angular.module("ikApp").directive("dateComponent",["$interval",function(t){return{restrict:"E",replace:!0,templateUrl:"/bundles/os2displayscreen/app/views/date.html?"+window.config.version,scope:{theme:"@"},link:function(e){e.thisDate=new Date;var n=t(function(){e.thisDate=new Date},6e4);e.$on("$destroy",function(){angular.isDefined(n)&&(t.cancel(n),n=void 0)})}}}])}.call(this),function(){"use strict";angular.module("ikApp").directive("digitalClockComponent",["$interval",function(t){return{restrict:"E",replace:!0,templateUrl:"/bundles/os2displayscreen/app/views/digital-clock.html?"+window.config.version,scope:{},link:function(e){e.thisDate=new Date;var n=t(function(){e.thisDate=Date.now()},1e3);e.$on("$destroy",function(){angular.isDefined(n)&&(t.cancel(n),n=void 0)})}}}])}.call(this),angular.module("ikApp").controller("IndexController",["$scope","$rootScope","$timeout","logging","cssInjector",function(o,t,i,s,a){"use strict";window.hasOwnProperty("slideFunctions")||(window.slideFunctions=[]),o.template="/bundles/os2displayscreen/app/views/index.html?"+window.config.version;var r=!1;o.fallbackImageUrl="/"+(window.config.fallback_image?window.config.fallback_image:"bundles/os2displayscreen/assets/images/fallback_default.png"),o.displayFallbackImage=!0;var c=[],l=[];o.activated=!0,o.activationCode="",o.screenTemplateLoaded=!1,o.submitActivationCode=function(e){t.$emit("activateScreenAndConnect",e)},t.$on("regionInfo",function(e,n){l[n.id]=n;var t=!1;l.forEach(function(e){0<e.scheduledSlides&&(t=!0)}),o.displayFallbackImage=!t}),t.$on("activationNotComplete",function(){i(function(){o.activated=!1})}),t.$on("awaitingContent",function(){i(function(){o.activated=!0})}),t.$on("start",function(e,n){i(function(){a.add(n.template.path_css),o.screenTemplateLoaded=n.template.path_live,o.template=n.template.path_live,o.templateDirectory=n.template.path,o.options=n.options}),r||i(function(){r=!0;for(var e=0;e<c.length;e++)s.info("Emitting channel saved channel."),t.$emit("addChannel",c[e])},1e3)}),t.$on("addChannel",function(e,n){r||(s.info("Saving channel until screen is ready."),c.push(n))}),o.logout=function(){t.$emit("connectionLogout")},t.$emit("connectionStart")}]),function(){"use strict";var o=!1;angular.module("ikApp").directive("itkKeypress",function(){return function(n,e,t){e.bind("keydown keypress",function(e){o=e.which===Number(t.modifier)||(o&&e.which===Number(t.key)&&(n.$apply(function(){n.$eval(t.itkKeypress)}),e.preventDefault()),!1)})}})}.call(this),!window.config||!window.config.logging)throw"logging Exception: window.config.logging does not exist";angular.module("ikApp").factory("logging",["$http","$timeout","$log",function(e,t,o){"use strict";var i=window.config.logging,s={message:null,error:function(e,n){if("none"!==i.logLevel){var t={type:"error",date:new Date,message:""+e,cause:n};s.message=t,i.logToConsole&&o.error(t)}},log:function(e,n){"all"===i.logLevel&&(s.message={type:"log",date:new Date,message:e},i.logToConsole&&o.log(e),n&&t(function(){s.message=null},n))},info:function(e,n){"all"===i.logLevel&&(s.message={type:"info",date:new Date,message:e},i.logToConsole&&o.info(e),n&&t(function(){s.message=null},n))},warn:function(e,n){"all"===i.logLevel&&(s.message={type:"warn",date:new Date,message:e},i.logToConsole&&o.warn(e),n&&t(function(){s.message=null},n))},clear:function(){s.message=null}};return s}]),angular.module("ikApp").directive("logging",["logging",function(n){"use strict";return{restrict:"E",templateUrl:"/bundles/os2displayscreen/app/views/logging.html",link:function(e){e.expanded=!1,e.toggleExpanded=function(){e.expanded=!e.expanded},e.clearLog=function(){n.clear()},e.getLogMessage=function(){return n.message}}}}]),angular.module("ikApp").factory("pull",["$rootScope","logging","$interval","$http",function(s,n,e,t){"use strict";var o={},i=window.config;if("pull"!==i.strategy)return o;n.info("Data strategy: 'pull'");var a=[],r=!1;function c(){t.get(i.updatePath).then(function(e){var n=e.data;r||(s.$emit("start",n.screen),r=!0);var t=Object.values(n.channels),o=a.filter(function(e){var n=e.data.id;return!t.find(function(e){return e.data.id===n})});for(var i in o.forEach(function(e){s.$emit("removeChannel",e.data)}),t)t.hasOwnProperty(i)&&function(n){a.find(function(e){return e.hash===n})||s.$emit("addChannel",i)}((i=t[i]).hash);a=t},function(e){n.error(e.data,e.status)})}return c(),s.$on("connectionStart",function(){n.info("Connection start"),e(c,1e3*i.updateInterval)}),o}]),function(){"use strict";var e=angular.module("ikApp");function u(e,n){this.scope=e,this.logging=n,this.scope.progressBoxElements=0,this.scope.progressBoxElementsIndex=0}function p(e,n,t,o,i,s,a,r,c){this.scope=e,this.logging=n,this.itkLog=n,this.progressBar=t,this.$timeout=o,this.$rootScope=i,this.$http=s,this.$interval=a,this.$sce=r,this.$filter=c,this.fadeTime=1e3,this.timeout=null}u.prototype.start=function(e){this.scope.progressBarStyle={overflow:"hidden","-webkit-transition":"width "+e+"s linear","-moz-transition":"width "+e+"s linear","-o-transition":"width "+e+"s linear",transition:"width "+e+"s linear",width:"100%"}},u.prototype.resetBox=function(){var e=this;e.logging.info("resetProgressBox"),e.scope.progressBoxElements=0;for(var n=e.scope.progressBoxElementsIndex=0,t=0;t<e.scope.channelKeys[e.scope.displayIndex].length;t++){var o=e.scope.channelKeys[e.scope.displayIndex][t],i=e.scope.channels[e.scope.displayIndex][o];if(i.isScheduled)for(var s=0;s<i.slides.length;s++){i.slides[s].isScheduled&&n++}}return e.scope.progressBoxElements=n},u.prototype.next=function(){this.reset(),this.scope.progressBoxElementsIndex++},u.prototype.reset=function(){this.scope.progressBarStyle={width:"0"}},p.prototype.broadcastInfo=function(e){this.$rootScope.$broadcast("regionInfo",{id:this.scope.regionId,scheduledSlides:e})},p.prototype.updateSlideScheduleState=function(e){var n=Math.round((new Date).getTime()/1e3),t=e.schedule_from,o=e.schedule_to,i=t&&0!==t,s=o&&0!==o;e.isScheduled=i&&!s?t<n:i&&s?t<o&&t<n&&n<o:!(!i&&s)||n<o},p.prototype.isChannelScheduled=function(e){if(!e.schedule_repeat)return!0;var n=new Date,t=n.getDay(),o=n.getHours(),i=e.schedule_repeat_from,s=e.schedule_repeat_to,a=e.schedule_repeat_days;if(!i&&!s&&0===a.length)return!0;for(var r=!1,c=0;c<a.length;c++)if(a[c].id===t){r=!0;break}return!!r&&(!(s<i)&&(i<=o&&o<s))},p.prototype.updateChannelScheduleState=function(e){var n=Math.round((new Date).getTime()/1e3),t=e.publish_from,o=e.publish_to;e.isScheduled=!1,this.isChannelScheduled(e)&&(e.isScheduled=!t&&!o||(!!(t&&t<n&&(!o||n<o))||!t&&n<o))},p.prototype.updateScheduling=function(){var i=this,s=i.scope.displayIndex;i.scope.channelKeys[s].forEach(function(e,n,t){var o=i.scope.channels[s][e];i.updateChannelScheduleState(o),o.slides.forEach(function(e){i.updateSlideScheduleState(e)})})},p.prototype.isContentScheduled=function(){for(var e=this,n=e.scope.displayIndex,t=e.scope.channelKeys[e.scope.displayIndex].length,o=0;o<t;o++){var i=e.scope.channels[n][e.scope.channelKeys[n][o]];if(i.isScheduled)for(var s=0;s<i.slides.length;s++)if(i.slides[s].isScheduled)return!0}return!1},p.prototype.restartShow=function(){var e=this;if(e.logging.info("Restart show"),e.scope.slideIndex=-1,e.scope.channelKey=-1,e.scope.slidesUpdated){var n=e.getShadowIndex(),t=e.scope.displayIndex,o=e.scope.channels;o[t]=angular.copy(o[n]),e.scope.channelKeys[t]=Object.keys(o[t]),e.scope.displayIndex=n,e.scope.slidesUpdated=!1}if(e.updateScheduling(),e.broadcastInfo(e.progressBar.resetBox()),!e.isContentScheduled())return e.$timeout.cancel(e.timeout),void(e.timeout=e.$timeout(function(){e.restartShow()},5e3));e.nextChannel()},p.prototype.nextChannel=function(){var e=this;e.scope.channelKey++;var n=e.scope.displayIndex,t=e.scope.channelKeys;if(e.scope.channelKey<t[n].length){var o=t[n][e.scope.channelKey],i=e.scope.channels[n][o];i.isScheduled?(e.scope.channelIndex=o,e.scope.slideIndex=-1,e.nextSlide()):e.nextChannel()}else e.restartShow()},p.prototype.nextSlide=function(){var e=this,n=e.scope.slideIndex+1,t=e.scope.displayIndex,o=e.scope.channels,i=e.scope.channelIndex;!o[t][i]||n>=o[t][i].slides.length?e.nextChannel():void 0===o[t][i]||o[t][i].slides.length<=0?e.nextChannel():(e.scope.slideIndex=n,o[t][i].slides[n].isScheduled?e.displaySlide():e.isContentScheduled()?(e.logging.info("Slide schedule: slides remain."),e.nextSlide()):(e.logging.info("Slide schedule: slides do not remain"),e.$timeout.cancel(e.timeout),e.$timeout(function(){e.restartShow()},1e3)))},p.prototype.updateSlideShow=function(e){var n=this,t=n.getShadowIndex(),o=""+e.id;n.scope.channels[t][o]=angular.copy(e),n.scope.channelKeys[t]=Object.keys(n.scope.channels[t]),n.scope.slidesUpdated=!0},p.prototype.displaySlide=function(){var e=this;e.$timeout.cancel(e.timeout),e.progressBar.next();var n=e.scope.channels[e.scope.displayIndex][e.scope.channelIndex].slides[e.scope.slideIndex];window.slideFunctions.hasOwnProperty(n.js_script_id)?window.slideFunctions[n.js_script_id].run(n,e):(e.logging.info('slideFunction "'+n.js_script_id+'" not defined. Wait 5 seconds and continue to next slide.'),e.$timeout(function(){e.nextSlide()},5e3))},p.prototype.getShadowIndex=function(){return(this.scope.displayIndex+1)%2},e.directive("region",["$rootScope","$timeout","$interval","logging","$http","$sce","$filter",function(e,c,n,l,t,o,d){return{restrict:"E",scope:{regionId:"=",showProgress:"=",scale:"="},link:function(i){i.channels=[{},{}];var s=!(i.channelKeys=[[],[]]);i.slideIndex=null,i.channelIndex=null,i.displayIndex=0,i.slidesUpdated=!1;var a=new u(i,l),r=new p(i,l,a,c,e,t,n,o,d);r.broadcastInfo(0),e.$on("addChannel",function(e,n){if(null!==n)if(-1!==n.regions.indexOf(i.regionId))l.info("Adding channel "+n.data.id+" to region "+i.regionId),s?r.updateSlideShow(n.data):(s=!0,c(function(){var e=""+n.data.id;i.channels[0][e]=angular.copy(n.data),i.channels[1][e]=angular.copy(n.data),i.channelKeys[0]=Object.keys(i.channels[0]),i.channelKeys[1]=Object.keys(i.channels[1]),i.channelKey=-1,c(function(){i.slideIndex=-1,r.updateScheduling(),r.broadcastInfo(a.resetBox()),r.nextChannel()},1e3)}));else{var t=r.getShadowIndex(),o=""+n.data.id;i.channels[t].hasOwnProperty(o)&&(l.info("Removing channel "+n.data.id+" from region "+i.regionId),delete i.channels[t][o],i.channelKeys[t]=Object.keys(i.channels[t]),i.slidesUpdated=!0)}}),e.$on("removeChannel",function(e,n){var t=r.getShadowIndex(),o=n.id;i.channels[t].hasOwnProperty(o)&&(l.info("Removing channel "+o+" from region "+i.regionId+" with shadowIndex: "+t),delete i.channels[t][o],i.channelKeys[t]=Object.keys(i.channels[t]),i.slidesUpdated=!0)})},templateUrl:"/bundles/os2displayscreen/app/views/region.html?"+window.config.version}}])}.call(this),angular.module("ikApp").directive("slide",["cssInjector",function(o){"use strict";return{restrict:"E",scope:{ikSlide:"=",show:"=",arrayId:"=",channelId:"=",index:"=",regionId:"=",scale:"="},link:function(n,e,t){n.ikSlide.uniqueId=null,t.$observe("regionId",function(e){e&&(n.ikSlide.uniqueId=n.regionId+"-"+n.arrayId+"-"+n.channelId+"-"+n.index)}),t.$observe("ikSlide",function(e){e&&(window.slideFunctions[n.ikSlide.js_script_id]?window.slideFunctions[n.ikSlide.js_script_id].setup(n):$.getScript(n.ikSlide.js_path,function(){window.slideFunctions[n.ikSlide.js_script_id].setup(n)}),o.add(n.ikSlide.css_path))})},template:'<div data-ng-include="ikSlide.template_path" class="slide-{{ikSlide.uniqueId}}"></div>'}}]),angular.module("ikApp").factory("socket",["$rootScope","logging",function(s,a){"use strict";var i,r,t={},c=window.config;if("push"!==c.strategy)return t;a.info("Data strategy: 'push'");var l=!1,d=function(o){var n=this;n.get=function(){if(localStorage.getItem(o))return localStorage.getItem(o);var e=new RegExp("(?:^"+o+"|s*"+o+")=(.*?)(?:;|$)","g").exec(document.cookie);return null!==e?(localStorage.setItem(o,e[1]),n.setCookie("","Thu, 01 Jan 1970 00:00:00 GMT"),e[1]):void 0},n.set=function(e,n){localStorage.setItem(o,e)},n.remove=function(){localStorage.removeItem(o),n.setCookie("","Thu, 01 Jan 1970 00:00:00 GMT")},n.setCookie=function(e,n){var t=o+"="+escape(e)+";";void 0===n&&(n="Mon, 18 Jan 2038 00:00:00 GMT"),t+="expires="+n+";",t+="path=/;",t+="domain="+document.domain+";",!0===c.cookie.secure&&(t+=" secure"),document.cookie=t}},u=function(e){var n=new d("indholdskanalen_uuid"),t=n.get();if(void 0===t){var o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";t=o.charAt(Math.floor(Math.random()*o.length))+Math.random().toString(36).substring(2),n.set(t)}(i=io.connect(c.ws.server,{query:"token="+e+"&uuid="+t,forceNew:!0,reconnection:!0,reconnectionDelay:1e3,reconnectionDelayMax:5e3,reconnectionAttempts:1/0})).on("connect",function(){r.set(e),a.log("Connection to middleware"),l=l||!0,i.emit("ready")}),i.on("booted",function(e){r.remove(),location.reload(!0)}),i.on("channelRemoved",function(e){s.$emit("removeChannel",e)}),i.on("error",function(e){a.error(e)}),i.on("disconnect",function(){a.info("disconnect")}),i.on("reconnect",function(){a.info("reconnect")}),i.on("reconnect_attempt",function(){a.info("reconnect_attempt")}),i.on("connect_error",function(){a.error("connect_error")}),i.on("reconnect_error",function(){a.error("reconnect_error")}),i.on("reconnect_failed",function(){a.error("reconnect_failed")}),i.on("ready",function(e){s.$emit("start",e.screen),200!==e.statusCode?404!==e.statusCode&&a.error("Code: "+e.statusCode+" - Connection error"):l||s.$emit("awaitingContent",{})}),i.on("reload",function(e){location.reload(!0)}),i.on("channelPush",function(e){s.$emit("addChannel",e)}),s.$on("logout",function(){i.emit("logout")})};return s.$on("connectionStart",function(){a.info("connectionStart"),t.start()}),s.$on("connectionLogout",function(){a.info("connectionLogout"),t.logout()}),s.$on("activateScreenAndConnect",function(e,n){a.info("activateScreenAndConnect"),t.activateScreenAndConnect(n)}),t.start=function(){!function e(n){var t=document.createElement("script");t.setAttribute("type","text/javascript"),t.setAttribute("src",c.resource.server+c.resource.uri+"/socket.io/socket.io.js?"+c.version),t.onload=function(){"undefined"==typeof io?(a.error("Socket.io not loaded"),document.getElementsByTagName("head")[0].removeChild(t),window.setTimeout(e(n),100)):n()},document.getElementsByTagName("head")[0].appendChild(t)}(function(){return function(){var e=(r=new d("indholdskanalen_token")).get();void 0===e?s.$emit("activationNotComplete"):u(e)}()})},t.logout=function(){s.$emit("logout"),r.remove(),location.reload(!0)},t.activateScreenAndConnect=function t(o){var i=new XMLHttpRequest;i.open("POST",c.resource.server+c.resource.uri+"/screen/activate",!0),i.setRequestHeader("Content-Type","application/json"),i.onload=function(e){if(4===i.readyState&&200===i.status)e=JSON.parse(i.responseText),u(e.token);else if(4===i.readyState&&409===i.status){if(e=JSON.parse(i.responseText),!0===confirm(e.message)){var n=new XMLHttpRequest;n.open("POST",c.resource.server+c.resource.uri+"/screen/kick",!0),n.setRequestHeader("Content-Type","application/json"),n.setRequestHeader("Authorization","Bearer "+e.token),n.onload=function(e){t(o)},n.onerror=function(e){s.$apply(function(){a.error("Kick request failed.",e)})},n.send(JSON.stringify({token:e.token}))}}else s.$apply(function(){a.error(i.responseText,i)})},i.onerror=function(e){s.$apply(function(){a.error("Activation request failed.",e)})},i.send(JSON.stringify({activationCode:o,apikey:c.apikey}))},t}]);